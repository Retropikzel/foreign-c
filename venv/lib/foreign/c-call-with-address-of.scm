(define-syntax call-with-address-of
  (syntax-rules ()
    ((_ cbv thunk)
     (let ((address-cbv (make-c-bytevector (c-type-size 'pointer))))
       (c-bytevector-pointer-set! address-cbv 0 cbv)
       (when (not (c-bytevector? cbv))
         (error "call-with-address-of: cbv argument must be c-bytevector"))
       (when (not (procedure? thunk))
         (error "call-with-address-of: thunk argument must be procedure"))
       (let ((result (apply thunk (list address-cbv))))
         (set! cbv (c-bytevector-pointer-ref address-cbv 0))
         (c-free address-cbv)
         result)))))
