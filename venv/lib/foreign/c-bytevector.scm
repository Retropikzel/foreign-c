(define (make-c-bytevector size . byte)
  (when (not (integer? size))
    (error "make-c-bytevector: Size must be integer" size))
  (let ((cbv (cond ((null? byte) (c-malloc size))
                   ((= (car byte) 0) (c-calloc 1 size))
                   (else (bytevector->c-bytevector (make-bytevector size (car byte)))))))
    (when (c-null? cbv)
      (c-perror (string->c-utf8 "make-c-bytevector error"))
      (error "make-c-bytevector error: malloc returned null" size))
    cbv))

(define c-bytevector
  (lambda bytes
    (bytevector->c-bytevector
      (apply (lambda (b) (make-bytevector 1 b)) bytes))))

(define (c-bytevector-set! cbv type offset value)
  (when (not (c-bytevector? cbv))
    (error "c-bytevector-set!: cbv argument must be c-bytevector" cbv))
  (when (not (symbol? type))
    (error "c-bytevector-set!: type must be symbol" type))
  (when (not (integer? offset))
    (error "c-bytevector-set!: offset argument must be integer" offset))
  (cond ((not (symbol? type)) (error "c-bytevector-set!: type must be symbol" type))
        ((symbol=? type 'i8)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-s8-set! cbv offset value))
        ((symbol=? type 'u8)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-u8-set! cbv offset value))
        ((symbol=? type 'i16)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value 2))
        ((symbol=? type 'u16)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-uint-set! cbv offset value 2))
        ((symbol=? type 'i32)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value 4))
        ((symbol=? type 'u32)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-uint-set! cbv offset value 4))
        ((symbol=? type 'i64)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value 8))
        ((symbol=? type 'u64)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-uint-set! cbv offset value 8))
        ((symbol=? type 'char)
         (when (not (char? value))
           (error "c-bytevector-set!: value for given type must be char"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-s8-set! cbv offset (char->integer value)))
        ((symbol=? type 'uchar)
         (when (not (char? value))
           (error "c-bytevector-set!: value for given type must be char"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-u8-set! cbv offset (char->integer value)))
        ((symbol=? type 'short)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'short)))
        ((symbol=? type 'ushort)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'ushort)))
        ((symbol=? type 'int)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'int)))
        ((symbol=? type 'uint)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'uint)))
        ((symbol=? type 'long)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'long)))
        ((symbol=? type 'ulong)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-sint-set! cbv offset value (c-type-size 'ulong)))
        ((symbol=? type 'float)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-ieee-single-native-set! cbv offset value))
        ((symbol=? type 'double)
         (when (not (number? value))
           (error "c-bytevector-set!: value for given type must be number"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-ieee-double-native-set! cbv offset value))
        ((symbol=? type 'pointer)
         (when (not (c-bytevector? value))
           (error "c-bytevector-set!: value for given type must be pointer"
                  `((type ,type)
                    (value ,value))))
         (c-bytevector-pointer-set! cbv offset value))
        (else (error "c-bytevector-set!: Unknown type" type))))

(define (c-bytevector-ref cbv type offset)
  (when (not (c-bytevector? cbv))
    (error "c-bytevector-ref: cbv argument must be c-bytevector" cbv))
  (when (not (symbol? type))
    (error "c-bytevector-ref: type must be symbol" type))
  (when (not (integer? offset))
    (error "c-bytevector-ref: offset argument must be integer" offset))
  (cond ((symbol=? type 'i8) (c-bytevector-s8-ref cbv offset))
        ((symbol=? type 'u8) (c-bytevector-u8-ref cbv offset))
        ((symbol=? type 'i16) (c-bytevector-sint-ref cbv offset 2))
        ((symbol=? type 'u16) (c-bytevector-uint-ref cbv offset 2))
        ((symbol=? type 'i32) (c-bytevector-sint-ref cbv offset 4))
        ((symbol=? type 'u32) (c-bytevector-uint-ref cbv offset 4))
        ((symbol=? type 'i64) (c-bytevector-sint-ref cbv offset 8))
        ((symbol=? type 'u64) (c-bytevector-uint-ref cbv offset 8))
        ((symbol=? type 'char) (integer->char (c-bytevector-s8-ref cbv offset)))
        ((symbol=? type 'uchar) (integer->char (c-bytevector-u8-ref cbv offset)))
        ((symbol=? type 'short) (c-bytevector-sint-ref cbv offset (c-type-size 'short)))
        ((symbol=? type 'ushort) (c-bytevector-uint-ref cbv offset (c-type-size 'ushort)))
        ((symbol=? type 'int) (c-bytevector-sint-ref cbv offset (c-type-size 'int)))
        ((symbol=? type 'uint) (c-bytevector-uint-ref cbv offset (c-type-size 'uint)))
        ((symbol=? type 'long) (c-bytevector-sint-ref cbv offset (c-type-size 'long)))
        ((symbol=? type 'ulong) (c-bytevector-uint-ref cbv offset (c-type-size 'ulong)))
        ((symbol=? type 'float) (c-bytevector-ieee-single-native-ref cbv offset))
        ((symbol=? type 'double) (c-bytevector-ieee-double-native-ref cbv offset))
        ((equal? type 'pointer) (c-bytevector-pointer-ref cbv offset))
        (else (error "c-bytevector-ref: Unknown type" type))))

(define (bytevector->c-bytevector bv)
  (when (not (bytevector? bv))
    (error "bytevector->c-bytevector: bv argument must be bytevector" bv))
  (letrec* ((bytes-length (bytevector-length bv))
            (pointer (make-c-bytevector bytes-length))
            (looper (lambda (index)
                      (when (< index bytes-length)
                        (c-bytevector-u8-set! pointer
                                              index
                                              (bytevector-u8-ref bv index))
                        (looper (+ index 1))))))
    (looper 0)
    pointer))

(define (c-bytevector->bytevector cbv size)
  (when (not (c-bytevector? cbv))
    (error "c-bytevector->bytevector: cbv argument must be c-bytevector" cbv))
  (when (not (integer? size))
    (error "c-bytevector->bytevector: size argument must be integer" size))
  (letrec* ((bv (make-bytevector size))
            (looper (lambda (index)
                      (let ((byte (c-bytevector-u8-ref cbv index)))
                        (if (= index size)
                          bv
                          (begin
                            (bytevector-u8-set! bv index byte)
                            (looper (+ index 1))))))))
    (looper 0)))

(define (c-utf8->string cbv)
  (when (not (c-bytevector? cbv))
    (error "c-utf8->string: cbv argument must be c-bytevector" cbv))
  (let ((size (c-strlen cbv)))
    (utf8->string (c-bytevector->bytevector cbv size))))

(define (string->c-utf8 str)
  (when (not (string? str))
    (error "string->c-utf8-: str argument must be string" str))
  (bytevector->c-bytevector
    (string->utf8
      (string-append str (string (integer->char 0))))))

(define (c-bytevector->integer cbv . offset)
  (when (not (c-bytevector? cbv))
    (error "c-bytevector->integer cbv argument must be c-bytevector" cbv))
  (let ((internal-offset (if (null? offset) 0 (car offset))))
    (when (not (integer? internal-offset))
      (error "c-bytevector->integer offset argument must be integer" (car offset)))
    (+ (c-memset-pointer->address cbv 0 0) internal-offset)))

(define (integer->c-bytevector address)
  (when (not (integer? address))
    (error "c-bytevector->string: address argument must be integer" address))
  (c-memset-address->pointer address 0 0))
